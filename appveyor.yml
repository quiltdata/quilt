image:
- Visual Studio 2015
- Visual Studio 2017

environment:
  global:
    CMD_IN_ENV: "cmd /E:ON /V:ON /C .\\appveyor\\run_with_env.cmd"
    TEST_REGISTRY: false
    # Just copy paste these vars from .travis.yml , but they are un-use
    FLASK_APP: quilt_server
    FLASK_DEBUG: 1
    QUILT_SERVER_CONFIG: dev_config.py

  matrix:
    - PYTHON: "C:\\Python35-x64"
      PYTHON_VERSION: "3.5.0"
      PYTHON_ARCH: "64"
      TEST_REGISTRY: false

    - PYTHON: "C:\\Python36-x64"
      PYTHON_VERSION: "3.6.0"
      PYTHON_ARCH: "64"
      TEST_REGISTRY: false

    # Enable this if want to use conda
    #- PYTHON: "C:\\Miniconda3"
    #  PYTHON_VERSION: "3"
    #  PYTHON_ARCH: "64"
    #  TEST_REGISTRY: true

init:
  - "ECHO %PYTHON_VERSION% %APPVEYOR_BUILD_NUMBER%"
  #- "ECHO %APPVEYOR_BUILD_NUMBER%

install:
  - echo $(python --version)
  - "SET PATH=%PYTHON%;%PYTHON%\\Scripts;%PATH%"
  - "SET PATH=%TEST_REGISTRY%;%TEST_REGISTRY%\\Scripts;%PATH%"
  - if "%PYTHON_VERSION%" == "3.5" set "BASE_PYTHON_VERSION=35"
  - if "%PYTHON_VERSION%" == "3.6" set "BASE_PYTHON_VERSION=3"
  - if "%PYTHON_ARCH%" == "64" set "ARCH_LABEL=-x64"
  # These are already installed on appveyor.  Update them.
  - set "CONDA_ROOT=C:\Miniconda%BASE_PYTHON_VERSION%%ARCH_LABEL%"
  - set "PATH=%CONDA_ROOT%;%CONDA_ROOT%\Scripts;%CONDA_ROOT%\Library\bin;%PATH%"
  - echo CONDA_PREFIX %CONDA_PREFIX%
  - conda config --set always_yes yes

  - ps: |
      if($env:PYTHON -match "conda")
      {
        conda update -y conda
        conda create --yes -n quilt_env python=$QPYVER pip
        #source activate quilt_env
        pip install pytest
      }
      else
      {
        pip install -U numpy pytest
      }

  - ECHO "Install quilt compiler"

  - ps: conda install pytorch-cpu torchvision-cpu -c pytorch
  - ps: pip install "$env:APPVEYOR_BUILD_FOLDER\compiler[img,tests]"
  - ps: |
      if($env:TEST_REGISTRY -match "true")
      {
        Write-Host "Install quilt registry"
        pip install -r "$env:APPVEYOR_BUILD_FOLDER\\registry\\requirements.txt"
        pip install "$env:APPVEYOR_BUILD_FOLDER\\registry"
      }

build: off

test_script:
  - ECHO "Test quilt compiler"
  - ps: pytest "$env:APPVEYOR_BUILD_FOLDER\\compiler"
  - ps: |
      if($env:TEST_REGISTRY -match "true")
      {
        Write-Host "Test registry"
        pytest "$env:APPVEYOR_BUILD_FOLDER\\registry"
      }
