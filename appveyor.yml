image: Visual Studio 2017

platform:
  - x64

environment:
  global:
    CMD_IN_ENV: "cmd /E:ON /V:ON /C"
    TEST_REGISTRY: false
    # Registry testing globals (currently not used)
    FLASK_APP: quilt_server
    FLASK_DEBUG: 1
    QUILT_SERVER_CONFIG: dev_config.py

  matrix:
    # see https://www.appveyor.com/docs/build-environment/#python
    - PYTHON_PATH: "C:\\Python35-x64"
      # pytorch for 3.5, no cuda see https://pytorch.org/
      TORCH: "http://download.pytorch.org/whl/cpu/torch-0.4.0-cp35-cp35m-win_amd64.whl"
    - PYTHON_PATH: "C:\\Python36-x64"
      # pytorch for 3.5, no cuda see https://pytorch.org/
      TORCH: "http://download.pytorch.org/whl/cpu/torch-0.4.0-cp36-cp36m-win_amd64.whl"
    fast_finish: true

install:
  - echo $(python --version)
  - set "PATH=%PYTHON_PATH%;%PATH%"
  - set PATH
  # Upgrade pip, setuptools since latest are Visual Studio C++ compiler aware
  - python -m pip install --upgrade pip setuptools
  - ps: pip install "$env:APPVEYOR_BUILD_FOLDER\\compiler[img,tests]"
  - ps: pip install "$env:TORCH"
  - ps: pip install "$env:APPVEYOR_BUILD_FOLDER\\compiler[torchvision] --no-deps"
  - ps: |
      if($env:TEST_REGISTRY -match "true")
      {
        Write-Host "Install quilt registry"
        pip install -r "$env:APPVEYOR_BUILD_FOLDER\\registry\\requirements.txt"
        pip install "$env:APPVEYOR_BUILD_FOLDER\\registry"
      }

build: off

test_script:
  - ECHO "Testing compiler..."
  - ps: pytest "$env:APPVEYOR_BUILD_FOLDER\\compiler"
  - ps: |
      if($env:TEST_REGISTRY -match "true")
      {
        ECHO "Testing registry..."
        pytest "$env:APPVEYOR_BUILD_FOLDER\\registry"
      }
