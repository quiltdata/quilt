<!-- markdownlint-disable MD013 -->
# Catalog Scripts

This directory contains utility scripts for the Quilt catalog application.

## connect-stack.js

A Node.js script for connecting to a Quilt stack and generating the necessary configuration for local development.

### Features

- **Config Reader**: Parses quilt3 Python config from `~/.quilt/config.yml` or `QUILT_CONFIG` environment variable using js-yaml
- **Stack Resolver**: Extracts and validates stack URL from the config
- **Auth Manager**: Handles Chrome-based authentication using Puppeteer
- **Config Generator**: Creates a `config.json` compatible with the existing catalog `Config.ts` structure
- **Integration**: Generates config that works with the existing `npm start` task

### Usage

#### Basic Usage

```bash
# Connect using existing quilt3 config
npm run connect:stack

# Connect to specific stack
npm run connect:stack -- --stack https://your-stack.example.com

# Connect and start dev server in one command
npm run start:connected
```

#### Command Line Options

```bash
node ./internals/scripts/connect-stack.js [options]

Options:
  --config <path>    Path to quilt3 config file (default: ~/.quilt/config.yml)
  --stack <url>      Stack URL to connect to (overrides config file)
  --no-auth          Skip authentication flow
  --port <port>      Port for dev server (default: 3000)
  --help             Show help message
```

#### Environment Variables

- `QUILT_CONFIG`: Path to quilt3 config file (alternative to `--config`)
- `PORT`: Dev server port (alternative to `--port`)

### Examples

```bash
# Use quilt3 config (runs 'quilt3 config' to get URL)
node connect-stack.js

# Use specific stack URL (overrides quilt3 config)
node connect-stack.js --stack https://my-stack.example.com

# Skip authentication
node connect-stack.js --no-auth

# Specify custom port
node connect-stack.js --port 8080

# Combined options
node connect-stack.js --stack https://my-stack.example.com --no-auth --port 8080
```

### How It Works

1. **Get Config**: The script runs the `quilt3 config` CLI command to retrieve the current quilt3 configuration

2. **Resolve Stack URL**: Extracts the stack URL from:
   - `--stack` command line option (highest priority)
   - Various fields from quilt3 config output (`default_registry`, `default_remote_registry`, etc.)

3. **Authenticate** (optional):
   - Launches Chrome browser using Puppeteer
   - Navigates to the stack's login page
   - Waits for user to complete authentication
   - Extracts authentication tokens from cookies/localStorage

4. **Fetch Stack Info**: Attempts to fetch the stack's configuration from `{stackUrl}/config.json`

5. **Generate Config**: Creates a configuration object that matches the `ConfigJson` TypeScript interface

6. **Write Config File**: Writes the configuration as a JavaScript file to `static-dev/config.js` that sets `window.QUILT_CATALOG_CONFIG`

### Output

The script generates a `config.js` file in the `static-dev` directory that looks like:

```javascript
// Auto-generated by connect-stack.js
// Do not edit this file directly
window.QUILT_CATALOG_CONFIG = {
  "region": "us-east-1",
  "mode": "LOCAL",
  "alwaysRequiresAuth": false,
  "serviceBucket": "your-service-bucket",
  "apiGatewayEndpoint": "https://your-stack.example.com/api",
  "registryUrl": "https://your-stack.example.com",
  "s3Proxy": "https://your-stack.example.com/proxy",
  // ... other configuration options
};
```

This file is automatically served by the webpack dev server and loaded by the catalog application.

### Dependencies

- `js-yaml`: For parsing YAML config files
- `puppeteer`: For Chrome-based authentication (installed automatically if needed)

### Error Handling

The script includes comprehensive error handling for:

- Missing config files (graceful fallback)
- Invalid URLs
- Network errors when fetching stack info
- Authentication timeouts
- Chrome/Puppeteer installation issues

### Integration with Webpack

The generated `config.js` file is placed in the `static-dev` directory, which is served by the webpack development server. The main `index.html` includes this file with:

```html
<script defer src="/config.js"></script>
```

The `Config.ts` module then reads the configuration from `window.QUILT_CATALOG_CONFIG`.

### NPM Scripts

The following npm scripts are available:

- `npm run connect:stack`: Run the connection script
- `npm run start:connected`: Connect to stack and start dev server
- `npm run start`: Start dev server (expects config to already be generated)

### Files Generated/Modified

- `static-dev/config.js`: Generated configuration file (gitignored)
- `.catalog-config.json`: Alternative config location (gitignored)

Both files are added to `.gitignore` to prevent accidental commits of sensitive configuration data.
